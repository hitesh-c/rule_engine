"use strict";var Rt=Object.create;var me=Object.defineProperty;var Lt=Object.getOwnPropertyDescriptor;var kt=Object.getOwnPropertyNames,Ge=Object.getOwnPropertySymbols,Dt=Object.getPrototypeOf,Qe=Object.prototype.hasOwnProperty,It=Object.prototype.propertyIsEnumerable;var We=(t,e,r)=>e in t?me(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ze=(t,e)=>{for(var r in e||(e={}))Qe.call(e,r)&&We(t,r,e[r]);if(Ge)for(var r of Ge(e))It.call(e,r)&&We(t,r,e[r]);return t};var B=(t,e)=>()=>(t&&(e=t(t=0)),e);var et=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),Nt=(t,e)=>{for(var r in e)me(t,r,{get:e[r],enumerable:!0})},tt=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of kt(e))!Qe.call(t,n)&&n!==r&&me(t,n,{get:()=>e[n],enumerable:!(i=Lt(e,n))||i.enumerable});return t};var ge=(t,e,r)=>(r=t!=null?Rt(Dt(t)):{},tt(e||!t||!t.__esModule?me(r,"default",{value:t,enumerable:!0}):r,t)),Mt=t=>tt(me({},"__esModule",{value:!0}),t);function Tt(t){for(var e=t.length,r=5381,i=52711,n;e--;)n=t.charCodeAt(e),r=r*33^n,i=i*33^n;return(r>>>0)*4096+(i>>>0)}function qt(t,e){return t[0]>e[0]}function at(t,e){return t>e}function Ne(t,e){for(var r,i,n=0;n<t.length;++n){for(i=t[n],r=n-1;~r&&e(t[r],i);--r)t[r+1]=t[r];t[r+1]=i}return t}function F(t,e){return ve.object+Ee+Ft[t]+Ee+e}function Ie(t,e){var r=rt.get(t);if(r)return r;var i=F(e,"NOT_ENUMERABLE"+Ee+Ht++);return rt.set(t,i),i}function Xt(t,e,r){if(Kt[e])return it(e,t,r);if(e==="[object Date]")return F(e,t.getTime());if(e==="[object RegExp]")return F(e,t.toString());if(e==="[object Event]")return F(e,[t.bubbles,t.cancelBubble,t.cancelable,t.composed,t.currentTarget,t.defaultPrevented,t.eventPhase,t.isTrusted,t.returnValue,t.target,t.type].join());if(e==="[object Error]")return F(e,t.message+Ee+t.stack);if(e==="[object DocumentFragment]")return F(e,Qt(t));var i=e.match(Ut);return i?F("ELEMENT",i[1]+Ee+t.outerHTML):ot[e]?Ie(t,e):$t[e]?F(e,t.toString()):it("CUSTOM",t,r)}function it(t,e,r){var i=r.cache.get(e);return i?F(t,"RECURSIVE~"+i):(r.cache.set(e,++r.id),t==="[object Object]"?e[Symbol.iterator]?Ie(e,t):F(t,st(e,r)):Bt[t]?F(t,Yt(e,r)):t==="[object Map]"?F(t,Zt(e,r)):t==="[object Set]"?F(t,er(e,r)):Vt[t]?F(t,e.join()):t==="[object ArrayBuffer]"?F(t,nt(e)):t==="[object DataView]"?F(t,nt(e.buffer)):ot[t]?Ie(e,t):F("CUSTOM",st(e,r)))}function Yt(t,e){for(var r=t.length,i=new Array(r);--r>=0;)i[r]=fe(t[r],e);return i.join()}function zt(t){return Buffer.from(t).toString("utf8")}function Gt(t){return String.fromCharCode.apply(null,new Uint16Array(t))}function Wt(){return"UNSUPPORTED"}function Qt(t){for(var e=t.children,r=e.length,i=new Array(r);--r>=0;)i[r]=e[r].outerHTML;return i.join()}function Zt(t,e){var r=new Array(t.size),i=0;for(t.forEach(function(n,c){r[i++]=[fe(c,e),fe(n,e)]}),Ne(r,qt);--i>=0;)r[i]="["+r[i][0]+","+r[i][1]+"]";return"["+r.join()+"]"}function st(t,e){for(var r=Ne(Object.getOwnPropertyNames(t),at),i=r.length,n=new Array(i),c=i;--c>=0;)n[c]=r[c]+":"+fe(t[r[c]],e);return"{"+n.join()+"}"}function er(t,e){var r=new Array(t.size),i=0;return t.forEach(function(n){r[i++]=fe(n,e)}),"["+Ne(r,at).join()+"]"}function fe(t,e){var r=typeof t;return t==null||r==="undefined"?ve.empty+t:r==="object"?Xt(t,Jt.call(t),e||{cache:new WeakMap,id:1}):r==="function"||r==="symbol"?ve[r]+t.toString():r==="boolean"?ve.boolean+ +t:ve[r]+t}function lt(t){return Tt(fe(t,void 0))}var Ee,Ut,Ft,Bt,ot,$t,Vt,Kt,ve,rt,Ht,Jt,nt,ct=B(()=>{Ee="|",Ut=/\[object ([HTML|SVG](.*)Element)\]/,Ft={"[object Arguments]":0,"[object Array]":1,"[object ArrayBuffer]":2,"[object AsyncFunction]":3,"[object AsyncGeneratorFunction]":4,"[object BigInt]":5,"[object BigInt64Array]":6,"[object BigUint64Array]":7,"[object Boolean]":8,"[object DataView]":9,"[object Date]":10,"[object DocumentFragment]":11,"[object Error]":12,"[object Event]":13,"[object Float32Array]":14,"[object Float64Array]":15,"[object Function]":16,"[object Generator]":17,"[object GeneratorFunction]":18,"[object Int8Array]":19,"[object Int16Array]":20,"[object Map]":21,"[object Number]":22,"[object Object]":23,"[object Promise]":24,"[object RegExp]":25,"[object Set]":26,"[object SharedArrayBuffer]":27,"[object String]":28,"[object Uint8Array]":29,"[object Uint8ClampedArray]":30,"[object Uint16Array]":31,"[object Uint32Array]":32,"[object WeakMap]":33,"[object WeakRef]":34,"[object WeakSet]":35,CUSTOM:36,ELEMENT:37},Bt={"[object Arguments]":1,"[object Array]":2},ot={"[object Generator]":1,"[object Promise]":2,"[object WeakMap]":3,"[object WeakRef]":4,"[object WeakSet]":5},$t={"[object AsyncFunction]":1,"[object AsyncGeneratorFunction]":2,"[object Boolean]":3,"[object Function]":4,"[object GeneratorFunction]":5,"[object Number]":6,"[object String]":7},Vt={"[object BigInt64Array]":1,"[object BigUint64Array]":2,"[object Float32Array]":3,"[object Float64Array]":4,"[object Int8Array]":5,"[object Int16Array]":6,"[object Uint8Array]":7,"[object Uint8ClampedArray]":8,"[object Uint16Array]":9,"[object Uint32Array]":10},Kt={"[object Arguments]":1,"[object Array]":2,"[object ArrayBuffer]":3,"[object BigInt64Array]":4,"[object BigUint64Array]":5,"[object DataView]":6,"[object Float32Array]":7,"[object Float64Array]":8,"[object Int8Array]":9,"[object Int16Array]":10,"[object Map]":11,"[object Object]":12,"[object Set]":13,"[object SharedArrayBuffer]":14,"[object Uint8Array]":15,"[object Uint8ClampedArray]":16,"[object Uint16Array]":17,"[object Uint32Array]":18,CUSTOM:19},ve={bigint:"i",boolean:"b",empty:"e",function:"g",number:"n",object:"o",string:"s",symbol:"s"};rt=new WeakMap,Ht=0;Jt=Object.prototype.toString;nt=typeof Buffer!="undefined"&&typeof Buffer.from=="function"?zt:typeof Uint16Array=="function"?Gt:Wt});var we,z,je=B(()=>{"use strict";ct();we=class t{constructor(e,r,i){this.id=e;let n={cache:!0};if(typeof i=="undefined"&&(i=n),typeof r!="function"?(this.value=r,this.type=this.constructor.CONSTANT):(this.calculationMethod=r,this.type=this.constructor.DYNAMIC),!this.id)throw new Error("factId required");return this.priority=parseInt(i.priority||1,10),this.options=Object.assign({},n,i),this.cacheKeyMethod=this.defaultCacheKeys,this}isConstant(){return this.type===this.constructor.CONSTANT}isDynamic(){return this.type===this.constructor.DYNAMIC}calculate(e,r){return Object.prototype.hasOwnProperty.call(this,"value")?this.value:this.calculationMethod(e,r)}static hashFromObject(e){return lt(e)}defaultCacheKeys(e,r){return{params:r,id:e}}getCacheKey(e){if(this.options.cache===!0){let r=this.cacheKeyMethod(this.id,e);return t.hashFromObject(r)}}};we.CONSTANT="CONSTANT";we.DYNAMIC="DYNAMIC";z=we});function tr(){try{if(typeof process!="undefined"&&process.env&&process.env.DEBUG&&process.env.DEBUG.match(/json-rules-engine/)||typeof window!="undefined"&&window.localStorage&&window.localStorage.debug&&window.localStorage.debug.match(/json-rules-engine/))return console.debug.bind(console)}catch(t){}return()=>{}}var I,pe=B(()=>{I=tr()});var oe,Me=B(()=>{"use strict";pe();oe=class t{constructor(e){if(!e)throw new Error("Condition: constructor options required");let r=t.booleanOperator(e);if(Object.assign(this,e),r){let i=e[r],n=Array.isArray(i);if(r!=="not"&&!n)throw new Error(`"${r}" must be an array`);if(r==="not"&&n)throw new Error(`"${r}" cannot be an array`);this.operator=r,this.priority=parseInt(e.priority,10)||1,n?this[r]=i.map(c=>new t(c)):this[r]=new t(i)}else if(!Object.prototype.hasOwnProperty.call(e,"condition")){if(!Object.prototype.hasOwnProperty.call(e,"fact"))throw new Error('Condition: constructor "fact" property required');if(!Object.prototype.hasOwnProperty.call(e,"operator"))throw new Error('Condition: constructor "operator" property required');if(!Object.prototype.hasOwnProperty.call(e,"value"))throw new Error('Condition: constructor "value" property required');Object.prototype.hasOwnProperty.call(e,"priority")&&(e.priority=parseInt(e.priority,10))}}toJSON(e=!0){let r={};this.priority&&(r.priority=this.priority),this.name&&(r.name=this.name);let i=t.booleanOperator(this);return i?Array.isArray(this[i])?r[i]=this[i].map(n=>n.toJSON(!1)):r[i]=this[i].toJSON(!1):this.isConditionReference()?r.condition=this.condition:(r.operator=this.operator,r.value=this.value,r.fact=this.fact,this.factResult!==void 0&&(r.factResult=this.factResult),this.result!==void 0&&(r.result=this.result),this.params&&(r.params=this.params),this.path&&(r.path=this.path)),e?JSON.stringify(r):r}evaluate(e,r){if(!e)return Promise.reject(new Error("almanac required"));if(!r)return Promise.reject(new Error("operatorMap required"));if(this.isBooleanOperator())return Promise.reject(new Error("Cannot evaluate() a boolean condition"));let i=r.get(this.operator);return i?Promise.all([e.getValue(this.value),e.factValue(this.fact,this.params,this.path)]).then(([n,c])=>{let f=i.evaluate(c,n);return I("condition::evaluate",{leftHandSideValue:c,operator:this.operator,rightHandSideValue:n,result:f}),{result:f,leftHandSideValue:c,rightHandSideValue:n,operator:this.operator}}):Promise.reject(new Error(`Unknown operator: ${this.operator}`))}static booleanOperator(e){if(Object.prototype.hasOwnProperty.call(e,"any"))return"any";if(Object.prototype.hasOwnProperty.call(e,"all"))return"all";if(Object.prototype.hasOwnProperty.call(e,"not"))return"not"}booleanOperator(){return t.booleanOperator(this)}isBooleanOperator(){return t.booleanOperator(this)!==void 0}isConditionReference(){return Object.prototype.hasOwnProperty.call(this,"condition")}}});var Te=et((Er,Ce)=>{var rr=function(){"use strict";function t(v,d){return d!=null&&v instanceof d}var e;try{e=Map}catch(v){e=function(){}}var r;try{r=Set}catch(v){r=function(){}}var i;try{i=Promise}catch(v){i=function(){}}function n(v,d,O,g,C){typeof d=="object"&&(O=d.depth,g=d.prototype,C=d.includeNonEnumerable,d=d.circular);var S=[],K=[],J=typeof Buffer!="undefined";typeof d=="undefined"&&(d=!0),typeof O=="undefined"&&(O=1/0);function X(j,G){if(j===null)return null;if(G===0)return j;var D,te;if(typeof j!="object")return j;if(t(j,e))D=new e;else if(t(j,r))D=new r;else if(t(j,i))D=new i(function(Q,se){j.then(function(s){Q(X(s,G-1))},function(s){se(X(s,G-1))})});else if(n.__isArray(j))D=[];else if(n.__isRegExp(j))D=new RegExp(j.source,E(j)),j.lastIndex&&(D.lastIndex=j.lastIndex);else if(n.__isDate(j))D=new Date(j.getTime());else{if(J&&Buffer.isBuffer(j))return Buffer.allocUnsafe?D=Buffer.allocUnsafe(j.length):D=new Buffer(j.length),j.copy(D),D;t(j,Error)?D=Object.create(j):typeof g=="undefined"?(te=Object.getPrototypeOf(j),D=Object.create(te)):(D=Object.create(g),te=g)}if(d){var N=S.indexOf(j);if(N!=-1)return K[N];S.push(j),K.push(D)}t(j,e)&&j.forEach(function(Q,se){var s=X(se,G-1),o=X(Q,G-1);D.set(s,o)}),t(j,r)&&j.forEach(function(Q){var se=X(Q,G-1);D.add(se)});for(var Y in j){var ce;te&&(ce=Object.getOwnPropertyDescriptor(te,Y)),!(ce&&ce.set==null)&&(D[Y]=X(j[Y],G-1))}if(Object.getOwnPropertySymbols)for(var ue=Object.getOwnPropertySymbols(j),Y=0;Y<ue.length;Y++){var ne=ue[Y],re=Object.getOwnPropertyDescriptor(j,ne);re&&!re.enumerable&&!C||(D[ne]=X(j[ne],G-1),re.enumerable||Object.defineProperty(D,ne,{enumerable:!1}))}if(C)for(var x=Object.getOwnPropertyNames(j),Y=0;Y<x.length;Y++){var he=x[Y],re=Object.getOwnPropertyDescriptor(j,he);re&&re.enumerable||(D[he]=X(j[he],G-1),Object.defineProperty(D,he,{enumerable:!1}))}return D}return X(v,O)}n.clonePrototype=function(d){if(d===null)return null;var O=function(){};return O.prototype=d,new O};function c(v){return Object.prototype.toString.call(v)}n.__objToStr=c;function f(v){return typeof v=="object"&&c(v)==="[object Date]"}n.__isDate=f;function w(v){return typeof v=="object"&&c(v)==="[object Array]"}n.__isArray=w;function _(v){return typeof v=="object"&&c(v)==="[object RegExp]"}n.__isRegExp=_;function E(v){var d="";return v.global&&(d+="g"),v.ignoreCase&&(d+="i"),v.multiline&&(d+="m"),d}return n.__getRegExpFlags=E,n}();typeof Ce=="object"&&Ce.exports&&(Ce.exports=rr)});var _e,Oe,ut=B(()=>{"use strict";_e=ge(Te()),Oe=class{constructor(e,r,i,n){this.conditions=(0,_e.default)(e),this.event=(0,_e.default)(r),this.priority=(0,_e.default)(i),this.name=(0,_e.default)(n),this.result=null}setResult(e){this.result=e}resolveEventParams(e){if(this.event.params!==null&&typeof this.event.params=="object"){let r=[];for(let i in this.event.params)Object.prototype.hasOwnProperty.call(this.event.params,i)&&r.push(e.getValue(this.event.params[i]).then(n=>this.event.params[i]=n));return Promise.all(r)}return Promise.resolve()}toJSON(e=!0){let r={conditions:this.conditions.toJSON(!1),event:this.event,priority:this.priority,name:this.name,result:this.result};return e?JSON.stringify(r):r}}});var Ue=et((ht,ft)=>{(function(t){var e=Object.hasOwnProperty,r=Array.isArray?Array.isArray:function(o){return Object.prototype.toString.call(o)==="[object Array]"},i=10,n=typeof process=="object"&&typeof process.nextTick=="function",c=typeof Symbol=="function",f=typeof Reflect=="object",w=typeof setImmediate=="function",_=w?setImmediate:setTimeout,E=c?f&&typeof Reflect.ownKeys=="function"?Reflect.ownKeys:function(s){var o=Object.getOwnPropertyNames(s);return o.push.apply(o,Object.getOwnPropertySymbols(s)),o}:Object.keys;function v(){this._events={},this._conf&&d.call(this,this._conf)}function d(s){s&&(this._conf=s,s.delimiter&&(this.delimiter=s.delimiter),s.maxListeners!==t&&(this._maxListeners=s.maxListeners),s.wildcard&&(this.wildcard=s.wildcard),s.newListener&&(this._newListener=s.newListener),s.removeListener&&(this._removeListener=s.removeListener),s.verboseMemoryLeak&&(this.verboseMemoryLeak=s.verboseMemoryLeak),s.ignoreErrors&&(this.ignoreErrors=s.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function O(s,o){var a="(node) warning: possible EventEmitter memory leak detected. "+s+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(a+=" Event name: "+o+"."),typeof process!="undefined"&&process.emitWarning){var l=new Error(a);l.name="MaxListenersExceededWarning",l.emitter=this,l.count=s,process.emitWarning(l)}else console.error(a),console.trace&&console.trace()}var g=function(s,o,a){var l=arguments.length;switch(l){case 0:return[];case 1:return[s];case 2:return[s,o];case 3:return[s,o,a];default:for(var u=new Array(l);l--;)u[l]=arguments[l];return u}};function C(s,o){for(var a={},l,u=s.length,h=o?o.length:0,p=0;p<u;p++)l=s[p],a[l]=p<h?o[p]:t;return a}function S(s,o,a){this._emitter=s,this._target=o,this._listeners={},this._listenersCount=0;var l,u;if((a.on||a.off)&&(l=a.on,u=a.off),o.addEventListener?(l=o.addEventListener,u=o.removeEventListener):o.addListener?(l=o.addListener,u=o.removeListener):o.on&&(l=o.on,u=o.off),!l&&!u)throw Error("target does not implement any known event API");if(typeof l!="function")throw TypeError("on method must be a function");if(typeof u!="function")throw TypeError("off method must be a function");this._on=l,this._off=u;var h=s._observers;h?h.push(this):s._observers=[this]}Object.assign(S.prototype,{subscribe:function(s,o,a){var l=this,u=this._target,h=this._emitter,p=this._listeners,m=function(){var y=g.apply(null,arguments),b={data:y,name:o,original:s};if(a){var A=a.call(u,b);A!==!1&&h.emit.apply(h,[b.name].concat(y));return}h.emit.apply(h,[o].concat(y))};if(p[s])throw Error("Event '"+s+"' is already listening");this._listenersCount++,h._newListener&&h._removeListener&&!l._onNewListener?(this._onNewListener=function(y){y===o&&p[s]===null&&(p[s]=m,l._on.call(u,s,m))},h.on("newListener",this._onNewListener),this._onRemoveListener=function(y){y===o&&!h.hasListeners(y)&&p[s]&&(p[s]=null,l._off.call(u,s,m))},p[s]=null,h.on("removeListener",this._onRemoveListener)):(p[s]=m,l._on.call(u,s,m))},unsubscribe:function(s){var o=this,a=this._listeners,l=this._emitter,u,h,p=this._off,m=this._target,y;if(s&&typeof s!="string")throw TypeError("event must be a string");function b(){o._onNewListener&&(l.off("newListener",o._onNewListener),l.off("removeListener",o._onRemoveListener),o._onNewListener=null,o._onRemoveListener=null);var A=te.call(l,o);l._observers.splice(A,1)}if(s){if(u=a[s],!u)return;p.call(m,s,u),delete a[s],--this._listenersCount||b()}else{for(h=E(a),y=h.length;y-- >0;)s=h[y],p.call(m,s,a[s]);this._listeners={},this._listenersCount=0,b()}}});function K(s,o,a,l){var u=Object.assign({},o);if(!s)return u;if(typeof s!="object")throw TypeError("options must be an object");var h=Object.keys(s),p=h.length,m,y,b;function A(R){throw Error('Invalid "'+m+'" option value'+(R?". Reason: "+R:""))}for(var U=0;U<p;U++){if(m=h[U],!l&&!e.call(o,m))throw Error('Unknown "'+m+'" option');y=s[m],y!==t&&(b=a[m],u[m]=b?b(y,A):y)}return u}function J(s,o){return(typeof s!="function"||!s.hasOwnProperty("prototype"))&&o("value must be a constructor"),s}function X(s){var o="value must be type of "+s.join("|"),a=s.length,l=s[0],u=s[1];return a===1?function(h,p){if(typeof h===l)return h;p(o)}:a===2?function(h,p){var m=typeof h;if(m===l||m===u)return h;p(o)}:function(h,p){for(var m=typeof h,y=a;y-- >0;)if(m===s[y])return h;p(o)}}var j=X(["function"]),G=X(["object","function"]);function D(s,o,a){var l,u,h=0,p,m=new s(function(y,b,A){a=K(a,{timeout:0,overload:!1},{timeout:function(M,V){return M*=1,(typeof M!="number"||M<0||!Number.isFinite(M))&&V("timeout must be a positive number"),M}}),l=!a.overload&&typeof s.prototype.cancel=="function"&&typeof A=="function";function U(){u&&(u=null),h&&(clearTimeout(h),h=0)}var R=function(M){U(),y(M)},L=function(M){U(),b(M)};l?o(R,L,A):(u=[function(M){L(M||Error("canceled"))}],o(R,L,function(M){if(p)throw Error("Unable to subscribe on cancel event asynchronously");if(typeof M!="function")throw TypeError("onCancel callback must be a function");u.push(M)}),p=!0),a.timeout>0&&(h=setTimeout(function(){var M=Error("timeout");M.code="ETIMEDOUT",h=0,m.cancel(M),b(M)},a.timeout))});return l||(m.cancel=function(y){if(u){for(var b=u.length,A=1;A<b;A++)u[A](y);u[0](y),u=null}}),m}function te(s){var o=this._observers;if(!o)return-1;for(var a=o.length,l=0;l<a;l++)if(o[l]._target===s)return l;return-1}function N(s,o,a,l,u){if(!a)return null;if(l===0){var h=typeof o;if(h==="string"){var p,m,y=0,b=0,A=this.delimiter,U=A.length;if((m=o.indexOf(A))!==-1){p=new Array(5);do p[y++]=o.slice(b,m),b=m+U;while((m=o.indexOf(A,b))!==-1);p[y++]=o.slice(b),o=p,u=y}else o=[o],u=1}else h==="object"?u=o.length:(o=[o],u=1)}var R=null,L,M,V,Le,ke,be=o[l],De=o[l+1],Z,q;if(l===u)a._listeners&&(typeof a._listeners=="function"?(s&&s.push(a._listeners),R=[a]):(s&&s.push.apply(s,a._listeners),R=[a]));else if(be==="*"){for(Z=E(a),m=Z.length;m-- >0;)L=Z[m],L!=="_listeners"&&(q=N(s,o,a[L],l+1,u),q&&(R?R.push.apply(R,q):R=q));return R}else if(be==="**"){for(ke=l+1===u||l+2===u&&De==="*",ke&&a._listeners&&(R=N(s,o,a,u,u)),Z=E(a),m=Z.length;m-- >0;)L=Z[m],L!=="_listeners"&&(L==="*"||L==="**"?(a[L]._listeners&&!ke&&(q=N(s,o,a[L],u,u),q&&(R?R.push.apply(R,q):R=q)),q=N(s,o,a[L],l,u)):L===De?q=N(s,o,a[L],l+2,u):q=N(s,o,a[L],l,u),q&&(R?R.push.apply(R,q):R=q));return R}else a[be]&&(R=N(s,o,a[be],l+1,u));if(M=a["*"],M&&N(s,o,M,l+1,u),V=a["**"],V)if(l<u)for(V._listeners&&N(s,o,V,u,u),Z=E(V),m=Z.length;m-- >0;)L=Z[m],L!=="_listeners"&&(L===De?N(s,o,V[L],l+2,u):L===be?N(s,o,V[L],l+1,u):(Le={},Le[L]=V[L],N(s,o,{"**":Le},l+1,u)));else V._listeners?N(s,o,V,u,u):V["*"]&&V["*"]._listeners&&N(s,o,V["*"],u,u);return R}function Y(s,o,a){var l=0,u=0,h,p=this.delimiter,m=p.length,y;if(typeof s=="string")if((h=s.indexOf(p))!==-1){y=new Array(5);do y[l++]=s.slice(u,h),u=h+m;while((h=s.indexOf(p,u))!==-1);y[l++]=s.slice(u)}else y=[s],l=1;else y=s,l=s.length;if(l>1){for(h=0;h+1<l;h++)if(y[h]==="**"&&y[h+1]==="**")return}var b=this.listenerTree,A;for(h=0;h<l;h++)if(A=y[h],b=b[A]||(b[A]={}),h===l-1)return b._listeners?(typeof b._listeners=="function"&&(b._listeners=[b._listeners]),a?b._listeners.unshift(o):b._listeners.push(o),!b._listeners.warned&&this._maxListeners>0&&b._listeners.length>this._maxListeners&&(b._listeners.warned=!0,O.call(this,b._listeners.length,A))):b._listeners=o,!0;return!0}function ce(s,o,a,l){for(var u=E(s),h=u.length,p,m,y,b=s._listeners,A;h-- >0;)m=u[h],p=s[m],m==="_listeners"?y=a:y=a?a.concat(m):[m],A=l||typeof m=="symbol",b&&o.push(A?y:y.join(this.delimiter)),typeof p=="object"&&ce.call(this,p,o,y,A);return o}function ue(s){for(var o=E(s),a=o.length,l,u,h;a-- >0;)u=o[a],l=s[u],l&&(h=!0,u!=="_listeners"&&!ue(l)&&delete s[u]);return h}function ne(s,o,a){this.emitter=s,this.event=o,this.listener=a}ne.prototype.off=function(){return this.emitter.off(this.event,this.listener),this};function re(s,o,a){if(a===!0)u=!0;else if(a===!1)l=!0;else{if(!a||typeof a!="object")throw TypeError("options should be an object or true");var l=a.async,u=a.promisify,h=a.nextTick,p=a.objectify}if(l||h||u){var m=o,y=o._origin||o;if(h&&!n)throw Error("process.nextTick is not supported");u===t&&(u=o.constructor.name==="AsyncFunction"),o=function(){var b=arguments,A=this,U=this.event;return u?h?Promise.resolve():new Promise(function(R){_(R)}).then(function(){return A.event=U,m.apply(A,b)}):(h?process.nextTick:_)(function(){A.event=U,m.apply(A,b)})},o._async=!0,o._origin=y}return[o,p?new ne(this,s,o):this]}function x(s){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,d.call(this,s)}x.EventEmitter2=x,x.prototype.listenTo=function(s,o,a){if(typeof s!="object")throw TypeError("target musts be an object");var l=this;a=K(a,{on:t,off:t,reducers:t},{on:j,off:j,reducers:G});function u(h){if(typeof h!="object")throw TypeError("events must be an object");var p=a.reducers,m=te.call(l,s),y;m===-1?y=new S(l,s,a):y=l._observers[m];for(var b=E(h),A=b.length,U,R=typeof p=="function",L=0;L<A;L++)U=b[L],y.subscribe(U,h[U]||U,R?p:p&&p[U])}return r(o)?u(C(o)):u(typeof o=="string"?C(o.split(/\s+/)):o),this},x.prototype.stopListeningTo=function(s,o){var a=this._observers;if(!a)return!1;var l=a.length,u,h=!1;if(s&&typeof s!="object")throw TypeError("target should be an object");for(;l-- >0;)u=a[l],(!s||u._target===s)&&(u.unsubscribe(o),h=!0);return h},x.prototype.delimiter=".",x.prototype.setMaxListeners=function(s){s!==t&&(this._maxListeners=s,this._conf||(this._conf={}),this._conf.maxListeners=s)},x.prototype.getMaxListeners=function(){return this._maxListeners},x.prototype.event="",x.prototype.once=function(s,o,a){return this._once(s,o,!1,a)},x.prototype.prependOnceListener=function(s,o,a){return this._once(s,o,!0,a)},x.prototype._once=function(s,o,a,l){return this._many(s,1,o,a,l)},x.prototype.many=function(s,o,a,l){return this._many(s,o,a,!1,l)},x.prototype.prependMany=function(s,o,a,l){return this._many(s,o,a,!0,l)},x.prototype._many=function(s,o,a,l,u){var h=this;if(typeof a!="function")throw new Error("many only accepts instances of Function");function p(){return--o===0&&h.off(s,p),a.apply(this,arguments)}return p._origin=a,this._on(s,p,l,u)},x.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||v.call(this);var s=arguments[0],o,a=this.wildcard,l,u,h,p,m;if(s==="newListener"&&!this._newListener&&!this._events.newListener)return!1;if(a&&(o=s,s!=="newListener"&&s!=="removeListener"&&typeof s=="object")){if(u=s.length,c){for(h=0;h<u;h++)if(typeof s[h]=="symbol"){m=!0;break}}m||(s=s.join(this.delimiter))}var y=arguments.length,b;if(this._all&&this._all.length)for(b=this._all.slice(),h=0,u=b.length;h<u;h++)switch(this.event=s,y){case 1:b[h].call(this,s);break;case 2:b[h].call(this,s,arguments[1]);break;case 3:b[h].call(this,s,arguments[1],arguments[2]);break;default:b[h].apply(this,arguments)}if(a)b=[],N.call(this,b,o,this.listenerTree,0,u);else if(b=this._events[s],typeof b=="function"){switch(this.event=s,y){case 1:b.call(this);break;case 2:b.call(this,arguments[1]);break;case 3:b.call(this,arguments[1],arguments[2]);break;default:for(l=new Array(y-1),p=1;p<y;p++)l[p-1]=arguments[p];b.apply(this,l)}return!0}else b&&(b=b.slice());if(b&&b.length){if(y>3)for(l=new Array(y-1),p=1;p<y;p++)l[p-1]=arguments[p];for(h=0,u=b.length;h<u;h++)switch(this.event=s,y){case 1:b[h].call(this);break;case 2:b[h].call(this,arguments[1]);break;case 3:b[h].call(this,arguments[1],arguments[2]);break;default:b[h].apply(this,l)}return!0}else if(!this.ignoreErrors&&!this._all&&s==="error")throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},x.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||v.call(this);var s=arguments[0],o=this.wildcard,a,l,u,h,p,m;if(s==="newListener"&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(a=s,s!=="newListener"&&s!=="removeListener"&&typeof s=="object")){if(h=s.length,c){for(p=0;p<h;p++)if(typeof s[p]=="symbol"){l=!0;break}}l||(s=s.join(this.delimiter))}var y=[],b=arguments.length,A;if(this._all)for(p=0,h=this._all.length;p<h;p++)switch(this.event=s,b){case 1:y.push(this._all[p].call(this,s));break;case 2:y.push(this._all[p].call(this,s,arguments[1]));break;case 3:y.push(this._all[p].call(this,s,arguments[1],arguments[2]));break;default:y.push(this._all[p].apply(this,arguments))}if(o?(A=[],N.call(this,A,a,this.listenerTree,0)):A=this._events[s],typeof A=="function")switch(this.event=s,b){case 1:y.push(A.call(this));break;case 2:y.push(A.call(this,arguments[1]));break;case 3:y.push(A.call(this,arguments[1],arguments[2]));break;default:for(u=new Array(b-1),m=1;m<b;m++)u[m-1]=arguments[m];y.push(A.apply(this,u))}else if(A&&A.length){if(A=A.slice(),b>3)for(u=new Array(b-1),m=1;m<b;m++)u[m-1]=arguments[m];for(p=0,h=A.length;p<h;p++)switch(this.event=s,b){case 1:y.push(A[p].call(this));break;case 2:y.push(A[p].call(this,arguments[1]));break;case 3:y.push(A[p].call(this,arguments[1],arguments[2]));break;default:y.push(A[p].apply(this,u))}}else if(!this.ignoreErrors&&!this._all&&s==="error")return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(y)},x.prototype.on=function(s,o,a){return this._on(s,o,!1,a)},x.prototype.prependListener=function(s,o,a){return this._on(s,o,!0,a)},x.prototype.onAny=function(s){return this._onAny(s,!1)},x.prototype.prependAny=function(s){return this._onAny(s,!0)},x.prototype.addListener=x.prototype.on,x.prototype._onAny=function(s,o){if(typeof s!="function")throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),o?this._all.unshift(s):this._all.push(s),this},x.prototype._on=function(s,o,a,l){if(typeof s=="function")return this._onAny(s,o),this;if(typeof o!="function")throw new Error("on only accepts instances of Function");this._events||v.call(this);var u=this,h;return l!==t&&(h=re.call(this,s,o,l),o=h[0],u=h[1]),this._newListener&&this.emit("newListener",s,o),this.wildcard?(Y.call(this,s,o,a),u):(this._events[s]?(typeof this._events[s]=="function"&&(this._events[s]=[this._events[s]]),a?this._events[s].unshift(o):this._events[s].push(o),!this._events[s].warned&&this._maxListeners>0&&this._events[s].length>this._maxListeners&&(this._events[s].warned=!0,O.call(this,this._events[s].length,s))):this._events[s]=o,u)},x.prototype.off=function(s,o){if(typeof o!="function")throw new Error("removeListener only takes instances of Function");var a,l=[];if(this.wildcard){var u=typeof s=="string"?s.split(this.delimiter):s.slice();if(l=N.call(this,null,u,this.listenerTree,0),!l)return this}else{if(!this._events[s])return this;a=this._events[s],l.push({_listeners:a})}for(var h=0;h<l.length;h++){var p=l[h];if(a=p._listeners,r(a)){for(var m=-1,y=0,b=a.length;y<b;y++)if(a[y]===o||a[y].listener&&a[y].listener===o||a[y]._origin&&a[y]._origin===o){m=y;break}if(m<0)continue;return this.wildcard?p._listeners.splice(m,1):this._events[s].splice(m,1),a.length===0&&(this.wildcard?delete p._listeners:delete this._events[s]),this._removeListener&&this.emit("removeListener",s,o),this}else(a===o||a.listener&&a.listener===o||a._origin&&a._origin===o)&&(this.wildcard?delete p._listeners:delete this._events[s],this._removeListener&&this.emit("removeListener",s,o))}return this.listenerTree&&ue(this.listenerTree),this},x.prototype.offAny=function(s){var o=0,a=0,l;if(s&&this._all&&this._all.length>0){for(l=this._all,o=0,a=l.length;o<a;o++)if(s===l[o])return l.splice(o,1),this._removeListener&&this.emit("removeListenerAny",s),this}else{if(l=this._all,this._removeListener)for(o=0,a=l.length;o<a;o++)this.emit("removeListenerAny",l[o]);this._all=[]}return this},x.prototype.removeListener=x.prototype.off,x.prototype.removeAllListeners=function(s){if(s===t)return!this._events||v.call(this),this;if(this.wildcard){var o=N.call(this,null,s,this.listenerTree,0),a,l;if(!o)return this;for(l=0;l<o.length;l++)a=o[l],a._listeners=null;this.listenerTree&&ue(this.listenerTree)}else this._events&&(this._events[s]=null);return this},x.prototype.listeners=function(s){var o=this._events,a,l,u,h,p;if(s===t){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(a=E(o),h=a.length,u=[];h-- >0;)l=o[a[h]],typeof l=="function"?u.push(l):u.push.apply(u,l);return u}else{if(this.wildcard){if(p=this.listenerTree,!p)return[];var m=[],y=typeof s=="string"?s.split(this.delimiter):s.slice();return N.call(this,m,y,p,0),m}return o?(l=o[s],l?typeof l=="function"?[l]:l:[]):[]}},x.prototype.eventNames=function(s){var o=this._events;return this.wildcard?ce.call(this,this.listenerTree,[],null,s):o?E(o):[]},x.prototype.listenerCount=function(s){return this.listeners(s).length},x.prototype.hasListeners=function(s){if(this.wildcard){var o=[],a=typeof s=="string"?s.split(this.delimiter):s.slice();return N.call(this,o,a,this.listenerTree,0),o.length>0}var l=this._events,u=this._all;return!!(u&&u.length||l&&(s===t?E(l).length:l[s]))},x.prototype.listenersAny=function(){return this._all?this._all:[]},x.prototype.waitFor=function(s,o){var a=this,l=typeof o;return l==="number"?o={timeout:o}:l==="function"&&(o={filter:o}),o=K(o,{timeout:0,filter:t,handleError:!1,Promise,overload:!1},{filter:j,Promise:J}),D(o.Promise,function(u,h,p){function m(){var y=o.filter;if(!(y&&!y.apply(a,arguments)))if(a.off(s,m),o.handleError){var b=arguments[0];b?h(b):u(g.apply(null,arguments).slice(1))}else u(g.apply(null,arguments))}p(function(){a.off(s,m)}),a._on(s,m,!1)},{timeout:o.timeout,overload:o.overload})};function he(s,o,a){a=K(a,{Promise,timeout:0,overload:!1},{Promise:J});var l=a.Promise;return D(l,function(u,h,p){var m;if(typeof s.addEventListener=="function"){m=function(){u(g.apply(null,arguments))},p(function(){s.removeEventListener(o,m)}),s.addEventListener(o,m,{once:!0});return}var y=function(){b&&s.removeListener("error",b),u(g.apply(null,arguments))},b;o!=="error"&&(b=function(A){s.removeListener(o,y),h(A)},s.once("error",b)),p(function(){b&&s.removeListener("error",b),s.removeListener(o,y)}),s.once(o,y)},{timeout:a.timeout,overload:a.overload})}var Q=x.prototype;if(Object.defineProperties(x,{defaultMaxListeners:{get:function(){return Q._maxListeners},set:function(s){if(typeof s!="number"||s<0||Number.isNaN(s))throw TypeError("n must be a non-negative number");Q._maxListeners=s},enumerable:!0},once:{value:he,writable:!0,configurable:!0}}),Object.defineProperties(Q,{_maxListeners:{value:i,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),typeof define=="function"&&define.amd)define(function(){return x});else if(typeof ht=="object")ft.exports=x;else{var se=new Function("","return this")();se.EventEmitter2=x}})()});var pt,dt,Fe,de,Be=B(()=>{"use strict";Me();ut();pe();pt=ge(Te()),dt=ge(Ue()),Fe=class extends dt.default{constructor(e){super(),typeof e=="string"&&(e=JSON.parse(e)),e&&e.conditions&&this.setConditions(e.conditions),e&&e.onSuccess&&this.on("success",e.onSuccess),e&&e.onFailure&&this.on("failure",e.onFailure),e&&(e.name||e.name===0)&&this.setName(e.name);let r=e&&e.priority||1;this.setPriority(r);let i=e&&e.event||{type:"unknown"};this.setEvent(i)}setPriority(e){if(e=parseInt(e,10),e<=0)throw new Error("Priority must be greater than zero");return this.priority=e,this}setName(e){if(!e&&e!==0)throw new Error('Rule "name" must be defined');return this.name=e,this}setConditions(e){if(!Object.prototype.hasOwnProperty.call(e,"all")&&!Object.prototype.hasOwnProperty.call(e,"any")&&!Object.prototype.hasOwnProperty.call(e,"not")&&!Object.prototype.hasOwnProperty.call(e,"condition"))throw new Error('"conditions" root must contain a single instance of "all", "any", "not", or "condition"');return this.conditions=new oe(e),this}setEvent(e){if(!e)throw new Error("Rule: setEvent() requires event object");if(!Object.prototype.hasOwnProperty.call(e,"type"))throw new Error('Rule: setEvent() requires event object with "type" property');return this.ruleEvent={type:e.type},e.params&&(this.ruleEvent.params=e.params),this}getEvent(){return this.ruleEvent}getPriority(){return this.priority}getConditions(){return this.conditions}getEngine(){return this.engine}setEngine(e){return this.engine=e,this}toJSON(e=!0){let r={conditions:this.conditions.toJSON(!1),priority:this.priority,event:this.ruleEvent,name:this.name};return e?JSON.stringify(r):r}prioritizeConditions(e){let r=e.reduce((i,n)=>{let c=n.priority;if(!c){let f=this.engine.getFact(n.fact);c=f&&f.priority||1}return i[c]||(i[c]=[]),i[c].push(n),i},{});return Object.keys(r).sort((i,n)=>Number(i)>Number(n)?-1:1).map(i=>r[i])}evaluate(e){let r=new Oe(this.conditions,this.ruleEvent,this.priority,this.name),i=d=>{if(d.isConditionReference())return E(d);if(d.isBooleanOperator()){let O=d[d.operator],g;return d.operator==="all"?g=w(O):d.operator==="any"?g=f(O):g=_(O),g.then(C=>{let S=C===!0;return d.result=S,S})}else return d.evaluate(e,this.engine.operators).then(O=>{let g=O.result;return d.factResult=O.leftHandSideValue,d.result=g,g})},n=(d,O)=>(Array.isArray(d)||(d=[d]),Promise.all(d.map(g=>i(g))).then(g=>(I("rule::evaluateConditions",{results:g}),O.call(g,C=>C===!0)))),c=(d,O)=>{if(d.length===0)return Promise.resolve(!0);if(d.length===1)return i(d[0]);let g=this.prioritizeConditions(d),C=Promise.resolve(O==="all");for(let S=0;S<g.length;S++){let K=g[S];C=C.then(J=>O==="any"?J||n(K,Array.prototype.some):J&&n(K,Array.prototype.every))}return C},f=d=>c(d,"any"),w=d=>c(d,"all"),_=d=>c([d],"not").then(O=>!O),E=d=>{let O=this.engine.conditions.get(d.condition);if(O)return delete d.condition,Object.assign(d,(0,pt.default)(O)),i(d);if(this.engine.allowUndefinedConditions)return d.result=!1,Promise.resolve(!1);throw new Error(`No condition ${d.condition} exists`)},v=d=>{r.setResult(d);let O=Promise.resolve();this.engine.replaceFactsInEventParams&&(O=r.resolveEventParams(e));let g=d?"success":"failure";return O.then(()=>this.emitAsync(g,r.event,e,r)).then(()=>r)};return r.conditions.any?f(r.conditions.any).then(d=>v(d)):r.conditions.all?w(r.conditions.all).then(d=>v(d)):r.conditions.not?_(r.conditions.not).then(d=>v(d)):E(r.conditions).then(d=>v(d))}},de=Fe});var Pe,yt=B(()=>{"use strict";Pe=class extends Error{constructor(...e){super(...e),this.code="UNDEFINED_FACT"}}});function ie(t,e){return t=t.slice(),t.push(e),t}function He(t,e){return e=e.slice(),e.unshift(t),e}function P(t,e,r,i,n){if(!(this instanceof P))try{return new P(t,e,r,i,n)}catch(f){if(!f.avoidNew)throw f;return f.value}typeof t=="string"&&(n=i,i=r,r=e,e=t,t=null);let c=t&&typeof t=="object";if(t=t||{},this.json=t.json||r,this.path=t.path||e,this.resultType=t.resultType||"value",this.flatten=t.flatten||!1,this.wrap=Object.hasOwn(t,"wrap")?t.wrap:!0,this.sandbox=t.sandbox||{},this.eval=t.eval===void 0?"safe":t.eval,this.ignoreEvalErrors=typeof t.ignoreEvalErrors=="undefined"?!1:t.ignoreEvalErrors,this.parent=t.parent||null,this.parentProperty=t.parentProperty||null,this.callback=t.callback||i||null,this.otherTypeCallback=t.otherTypeCallback||n||function(){throw new TypeError("You must supply an otherTypeCallback callback option with the @other() operator.")},t.autostart!==!1){let f={path:c?t.path:e};c?"json"in t&&(f.json=t.json):f.json=r;let w=this.evaluate(f);if(!w||typeof w!="object")throw new Je(w);return w}}var mt,Ve,Ke,H,ir,ee,nr,sr,or,bt,ar,lr,$e,cr,ye,k,qe,Je,gt=B(()=>{mt=ge(require("vm"),1),Ve=class{add(e,r,i){if(typeof arguments[0]!="string")for(let n in arguments[0])this.add(n,arguments[0][n],arguments[1]);else(Array.isArray(e)?e:[e]).forEach(function(n){this[n]=this[n]||[],r&&this[n][i?"unshift":"push"](r)},this)}run(e,r){this[e]=this[e]||[],this[e].forEach(function(i){i.call(r&&r.context?r.context:r,r)})}},Ke=class{constructor(e){this.jsep=e,this.registered={}}register(...e){e.forEach(r=>{if(typeof r!="object"||!r.name||!r.init)throw new Error("Invalid JSEP plugin format");this.registered[r.name]||(r.init(this.jsep),this.registered[r.name]=r)})}},H=class t{static get version(){return"1.3.9"}static toString(){return"JavaScript Expression Parser (JSEP) v"+t.version}static addUnaryOp(e){return t.max_unop_len=Math.max(e.length,t.max_unop_len),t.unary_ops[e]=1,t}static addBinaryOp(e,r,i){return t.max_binop_len=Math.max(e.length,t.max_binop_len),t.binary_ops[e]=r,i?t.right_associative.add(e):t.right_associative.delete(e),t}static addIdentifierChar(e){return t.additional_identifier_chars.add(e),t}static addLiteral(e,r){return t.literals[e]=r,t}static removeUnaryOp(e){return delete t.unary_ops[e],e.length===t.max_unop_len&&(t.max_unop_len=t.getMaxKeyLen(t.unary_ops)),t}static removeAllUnaryOps(){return t.unary_ops={},t.max_unop_len=0,t}static removeIdentifierChar(e){return t.additional_identifier_chars.delete(e),t}static removeBinaryOp(e){return delete t.binary_ops[e],e.length===t.max_binop_len&&(t.max_binop_len=t.getMaxKeyLen(t.binary_ops)),t.right_associative.delete(e),t}static removeAllBinaryOps(){return t.binary_ops={},t.max_binop_len=0,t}static removeLiteral(e){return delete t.literals[e],t}static removeAllLiterals(){return t.literals={},t}get char(){return this.expr.charAt(this.index)}get code(){return this.expr.charCodeAt(this.index)}constructor(e){this.expr=e,this.index=0}static parse(e){return new t(e).parse()}static getMaxKeyLen(e){return Math.max(0,...Object.keys(e).map(r=>r.length))}static isDecimalDigit(e){return e>=48&&e<=57}static binaryPrecedence(e){return t.binary_ops[e]||0}static isIdentifierStart(e){return e>=65&&e<=90||e>=97&&e<=122||e>=128&&!t.binary_ops[String.fromCharCode(e)]||t.additional_identifier_chars.has(String.fromCharCode(e))}static isIdentifierPart(e){return t.isIdentifierStart(e)||t.isDecimalDigit(e)}throwError(e){let r=new Error(e+" at character "+this.index);throw r.index=this.index,r.description=e,r}runHook(e,r){if(t.hooks[e]){let i={context:this,node:r};return t.hooks.run(e,i),i.node}return r}searchHook(e){if(t.hooks[e]){let r={context:this};return t.hooks[e].find(function(i){return i.call(r.context,r),r.node}),r.node}}gobbleSpaces(){let e=this.code;for(;e===t.SPACE_CODE||e===t.TAB_CODE||e===t.LF_CODE||e===t.CR_CODE;)e=this.expr.charCodeAt(++this.index);this.runHook("gobble-spaces")}parse(){this.runHook("before-all");let e=this.gobbleExpressions(),r=e.length===1?e[0]:{type:t.COMPOUND,body:e};return this.runHook("after-all",r)}gobbleExpressions(e){let r=[],i,n;for(;this.index<this.expr.length;)if(i=this.code,i===t.SEMCOL_CODE||i===t.COMMA_CODE)this.index++;else if(n=this.gobbleExpression())r.push(n);else if(this.index<this.expr.length){if(i===e)break;this.throwError('Unexpected "'+this.char+'"')}return r}gobbleExpression(){let e=this.searchHook("gobble-expression")||this.gobbleBinaryExpression();return this.gobbleSpaces(),this.runHook("after-expression",e)}gobbleBinaryOp(){this.gobbleSpaces();let e=this.expr.substr(this.index,t.max_binop_len),r=e.length;for(;r>0;){if(t.binary_ops.hasOwnProperty(e)&&(!t.isIdentifierStart(this.code)||this.index+e.length<this.expr.length&&!t.isIdentifierPart(this.expr.charCodeAt(this.index+e.length))))return this.index+=r,e;e=e.substr(0,--r)}return!1}gobbleBinaryExpression(){let e,r,i,n,c,f,w,_,E;if(f=this.gobbleToken(),!f||(r=this.gobbleBinaryOp(),!r))return f;for(c={value:r,prec:t.binaryPrecedence(r),right_a:t.right_associative.has(r)},w=this.gobbleToken(),w||this.throwError("Expected expression after "+r),n=[f,c,w];r=this.gobbleBinaryOp();){if(i=t.binaryPrecedence(r),i===0){this.index-=r.length;break}c={value:r,prec:i,right_a:t.right_associative.has(r)},E=r;let v=d=>c.right_a&&d.right_a?i>d.prec:i<=d.prec;for(;n.length>2&&v(n[n.length-2]);)w=n.pop(),r=n.pop().value,f=n.pop(),e={type:t.BINARY_EXP,operator:r,left:f,right:w},n.push(e);e=this.gobbleToken(),e||this.throwError("Expected expression after "+E),n.push(c,e)}for(_=n.length-1,e=n[_];_>1;)e={type:t.BINARY_EXP,operator:n[_-1].value,left:n[_-2],right:e},_-=2;return e}gobbleToken(){let e,r,i,n;if(this.gobbleSpaces(),n=this.searchHook("gobble-token"),n)return this.runHook("after-token",n);if(e=this.code,t.isDecimalDigit(e)||e===t.PERIOD_CODE)return this.gobbleNumericLiteral();if(e===t.SQUOTE_CODE||e===t.DQUOTE_CODE)n=this.gobbleStringLiteral();else if(e===t.OBRACK_CODE)n=this.gobbleArray();else{for(r=this.expr.substr(this.index,t.max_unop_len),i=r.length;i>0;){if(t.unary_ops.hasOwnProperty(r)&&(!t.isIdentifierStart(this.code)||this.index+r.length<this.expr.length&&!t.isIdentifierPart(this.expr.charCodeAt(this.index+r.length)))){this.index+=i;let c=this.gobbleToken();return c||this.throwError("missing unaryOp argument"),this.runHook("after-token",{type:t.UNARY_EXP,operator:r,argument:c,prefix:!0})}r=r.substr(0,--i)}t.isIdentifierStart(e)?(n=this.gobbleIdentifier(),t.literals.hasOwnProperty(n.name)?n={type:t.LITERAL,value:t.literals[n.name],raw:n.name}:n.name===t.this_str&&(n={type:t.THIS_EXP})):e===t.OPAREN_CODE&&(n=this.gobbleGroup())}return n?(n=this.gobbleTokenProperty(n),this.runHook("after-token",n)):this.runHook("after-token",!1)}gobbleTokenProperty(e){this.gobbleSpaces();let r=this.code;for(;r===t.PERIOD_CODE||r===t.OBRACK_CODE||r===t.OPAREN_CODE||r===t.QUMARK_CODE;){let i;if(r===t.QUMARK_CODE){if(this.expr.charCodeAt(this.index+1)!==t.PERIOD_CODE)break;i=!0,this.index+=2,this.gobbleSpaces(),r=this.code}this.index++,r===t.OBRACK_CODE?(e={type:t.MEMBER_EXP,computed:!0,object:e,property:this.gobbleExpression()},e.property||this.throwError('Unexpected "'+this.char+'"'),this.gobbleSpaces(),r=this.code,r!==t.CBRACK_CODE&&this.throwError("Unclosed ["),this.index++):r===t.OPAREN_CODE?e={type:t.CALL_EXP,arguments:this.gobbleArguments(t.CPAREN_CODE),callee:e}:(r===t.PERIOD_CODE||i)&&(i&&this.index--,this.gobbleSpaces(),e={type:t.MEMBER_EXP,computed:!1,object:e,property:this.gobbleIdentifier()}),i&&(e.optional=!0),this.gobbleSpaces(),r=this.code}return e}gobbleNumericLiteral(){let e="",r,i;for(;t.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(this.code===t.PERIOD_CODE)for(e+=this.expr.charAt(this.index++);t.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);if(r=this.char,r==="e"||r==="E"){for(e+=this.expr.charAt(this.index++),r=this.char,(r==="+"||r==="-")&&(e+=this.expr.charAt(this.index++));t.isDecimalDigit(this.code);)e+=this.expr.charAt(this.index++);t.isDecimalDigit(this.expr.charCodeAt(this.index-1))||this.throwError("Expected exponent ("+e+this.char+")")}return i=this.code,t.isIdentifierStart(i)?this.throwError("Variable names cannot start with a number ("+e+this.char+")"):(i===t.PERIOD_CODE||e.length===1&&e.charCodeAt(0)===t.PERIOD_CODE)&&this.throwError("Unexpected period"),{type:t.LITERAL,value:parseFloat(e),raw:e}}gobbleStringLiteral(){let e="",r=this.index,i=this.expr.charAt(this.index++),n=!1;for(;this.index<this.expr.length;){let c=this.expr.charAt(this.index++);if(c===i){n=!0;break}else if(c==="\\")switch(c=this.expr.charAt(this.index++),c){case"n":e+=`
`;break;case"r":e+="\r";break;case"t":e+="	";break;case"b":e+="\b";break;case"f":e+="\f";break;case"v":e+="\v";break;default:e+=c}else e+=c}return n||this.throwError('Unclosed quote after "'+e+'"'),{type:t.LITERAL,value:e,raw:this.expr.substring(r,this.index)}}gobbleIdentifier(){let e=this.code,r=this.index;for(t.isIdentifierStart(e)?this.index++:this.throwError("Unexpected "+this.char);this.index<this.expr.length&&(e=this.code,t.isIdentifierPart(e));)this.index++;return{type:t.IDENTIFIER,name:this.expr.slice(r,this.index)}}gobbleArguments(e){let r=[],i=!1,n=0;for(;this.index<this.expr.length;){this.gobbleSpaces();let c=this.code;if(c===e){i=!0,this.index++,e===t.CPAREN_CODE&&n&&n>=r.length&&this.throwError("Unexpected token "+String.fromCharCode(e));break}else if(c===t.COMMA_CODE){if(this.index++,n++,n!==r.length){if(e===t.CPAREN_CODE)this.throwError("Unexpected token ,");else if(e===t.CBRACK_CODE)for(let f=r.length;f<n;f++)r.push(null)}}else if(r.length!==n&&n!==0)this.throwError("Expected comma");else{let f=this.gobbleExpression();(!f||f.type===t.COMPOUND)&&this.throwError("Expected comma"),r.push(f)}}return i||this.throwError("Expected "+String.fromCharCode(e)),r}gobbleGroup(){this.index++;let e=this.gobbleExpressions(t.CPAREN_CODE);if(this.code===t.CPAREN_CODE)return this.index++,e.length===1?e[0]:e.length?{type:t.SEQUENCE_EXP,expressions:e}:!1;this.throwError("Unclosed (")}gobbleArray(){return this.index++,{type:t.ARRAY_EXP,elements:this.gobbleArguments(t.CBRACK_CODE)}}},ir=new Ve;Object.assign(H,{hooks:ir,plugins:new Ke(H),COMPOUND:"Compound",SEQUENCE_EXP:"SequenceExpression",IDENTIFIER:"Identifier",MEMBER_EXP:"MemberExpression",LITERAL:"Literal",THIS_EXP:"ThisExpression",CALL_EXP:"CallExpression",UNARY_EXP:"UnaryExpression",BINARY_EXP:"BinaryExpression",ARRAY_EXP:"ArrayExpression",TAB_CODE:9,LF_CODE:10,CR_CODE:13,SPACE_CODE:32,PERIOD_CODE:46,COMMA_CODE:44,SQUOTE_CODE:39,DQUOTE_CODE:34,OPAREN_CODE:40,CPAREN_CODE:41,OBRACK_CODE:91,CBRACK_CODE:93,QUMARK_CODE:63,SEMCOL_CODE:59,COLON_CODE:58,unary_ops:{"-":1,"!":1,"~":1,"+":1},binary_ops:{"||":1,"&&":2,"|":3,"^":4,"&":5,"==":6,"!=":6,"===":6,"!==":6,"<":7,">":7,"<=":7,">=":7,"<<":8,">>":8,">>>":8,"+":9,"-":9,"*":10,"/":10,"%":10},right_associative:new Set,additional_identifier_chars:new Set(["$","_"]),literals:{true:!0,false:!1,null:null},this_str:"this"});H.max_unop_len=H.getMaxKeyLen(H.unary_ops);H.max_binop_len=H.getMaxKeyLen(H.binary_ops);ee=t=>new H(t).parse(),nr=Object.getOwnPropertyNames(class{});Object.getOwnPropertyNames(H).filter(t=>!nr.includes(t)&&ee[t]===void 0).forEach(t=>{ee[t]=H[t]});ee.Jsep=H;sr="ConditionalExpression",or={name:"ternary",init(t){t.hooks.add("after-expression",function(r){if(r.node&&this.code===t.QUMARK_CODE){this.index++;let i=r.node,n=this.gobbleExpression();if(n||this.throwError("Expected expression"),this.gobbleSpaces(),this.code===t.COLON_CODE){this.index++;let c=this.gobbleExpression();if(c||this.throwError("Expected expression"),r.node={type:sr,test:i,consequent:n,alternate:c},i.operator&&t.binary_ops[i.operator]<=.9){let f=i;for(;f.right.operator&&t.binary_ops[f.right.operator]<=.9;)f=f.right;r.node.test=f.right,f.right=r.node,r.node=i}}else this.throwError("Expected :")}})}};ee.plugins.register(or);bt=47,ar=92,lr={name:"regex",init(t){t.hooks.add("gobble-token",function(r){if(this.code===bt){let i=++this.index,n=!1;for(;this.index<this.expr.length;){if(this.code===bt&&!n){let c=this.expr.slice(i,this.index),f="";for(;++this.index<this.expr.length;){let _=this.code;if(_>=97&&_<=122||_>=65&&_<=90||_>=48&&_<=57)f+=this.char;else break}let w;try{w=new RegExp(c,f)}catch(_){this.throwError(_.message)}return r.node={type:t.LITERAL,value:w,raw:this.expr.slice(i-1,this.index)},r.node=this.gobbleTokenProperty(r.node),r.node}this.code===t.OBRACK_CODE?n=!0:n&&this.code===t.CBRACK_CODE&&(n=!1),this.index+=this.code===ar?2:1}this.throwError("Unclosed Regex")}})}},$e=43,cr=45,ye={name:"assignment",assignmentOperators:new Set(["=","*=","**=","/=","%=","+=","-=","<<=",">>=",">>>=","&=","^=","|="]),updateOperators:[$e,cr],assignmentPrecedence:.9,init(t){let e=[t.IDENTIFIER,t.MEMBER_EXP];ye.assignmentOperators.forEach(i=>t.addBinaryOp(i,ye.assignmentPrecedence,!0)),t.hooks.add("gobble-token",function(n){let c=this.code;ye.updateOperators.some(f=>f===c&&f===this.expr.charCodeAt(this.index+1))&&(this.index+=2,n.node={type:"UpdateExpression",operator:c===$e?"++":"--",argument:this.gobbleTokenProperty(this.gobbleIdentifier()),prefix:!0},(!n.node.argument||!e.includes(n.node.argument.type))&&this.throwError(`Unexpected ${n.node.operator}`))}),t.hooks.add("after-token",function(n){if(n.node){let c=this.code;ye.updateOperators.some(f=>f===c&&f===this.expr.charCodeAt(this.index+1))&&(e.includes(n.node.type)||this.throwError(`Unexpected ${n.node.operator}`),this.index+=2,n.node={type:"UpdateExpression",operator:c===$e?"++":"--",argument:n.node,prefix:!1})}}),t.hooks.add("after-expression",function(n){n.node&&r(n.node)});function r(i){ye.assignmentOperators.has(i.operator)?(i.type="AssignmentExpression",r(i.left),r(i.right)):i.operator||Object.values(i).forEach(n=>{n&&typeof n=="object"&&r(n)})}}};ee.plugins.register(lr,ye);ee.addUnaryOp("typeof");ee.addLiteral("null",null);ee.addLiteral("undefined",void 0);k={evalAst(t,e){switch(t.type){case"BinaryExpression":case"LogicalExpression":return k.evalBinaryExpression(t,e);case"Compound":return k.evalCompound(t,e);case"ConditionalExpression":return k.evalConditionalExpression(t,e);case"Identifier":return k.evalIdentifier(t,e);case"Literal":return k.evalLiteral(t,e);case"MemberExpression":return k.evalMemberExpression(t,e);case"UnaryExpression":return k.evalUnaryExpression(t,e);case"ArrayExpression":return k.evalArrayExpression(t,e);case"CallExpression":return k.evalCallExpression(t,e);case"AssignmentExpression":return k.evalAssignmentExpression(t,e);default:throw SyntaxError("Unexpected expression",t)}},evalBinaryExpression(t,e){return{"||":(i,n)=>i||n(),"&&":(i,n)=>i&&n(),"|":(i,n)=>i|n(),"^":(i,n)=>i^n(),"&":(i,n)=>i&n(),"==":(i,n)=>i==n(),"!=":(i,n)=>i!=n(),"===":(i,n)=>i===n(),"!==":(i,n)=>i!==n(),"<":(i,n)=>i<n(),">":(i,n)=>i>n(),"<=":(i,n)=>i<=n(),">=":(i,n)=>i>=n(),"<<":(i,n)=>i<<n(),">>":(i,n)=>i>>n(),">>>":(i,n)=>i>>>n(),"+":(i,n)=>i+n(),"-":(i,n)=>i-n(),"*":(i,n)=>i*n(),"/":(i,n)=>i/n(),"%":(i,n)=>i%n()}[t.operator](k.evalAst(t.left,e),()=>k.evalAst(t.right,e))},evalCompound(t,e){let r;for(let i=0;i<t.body.length;i++){t.body[i].type==="Identifier"&&["var","let","const"].includes(t.body[i].name)&&t.body[i+1]&&t.body[i+1].type==="AssignmentExpression"&&(i+=1);let n=t.body[i];r=k.evalAst(n,e)}return r},evalConditionalExpression(t,e){return k.evalAst(t.test,e)?k.evalAst(t.consequent,e):k.evalAst(t.alternate,e)},evalIdentifier(t,e){if(t.name in e)return e[t.name];throw ReferenceError(`${t.name} is not defined`)},evalLiteral(t){return t.value},evalMemberExpression(t,e){if(t.property.type==="Identifier"&&t.property.name==="constructor"||t.object.type==="Identifier"&&t.object.name==="constructor")throw new Error("'constructor' property is disabled");let r=t.computed?k.evalAst(t.property):t.property.name,i=k.evalAst(t.object,e),n=i[r];if(typeof n=="function"){if(i===Function&&r==="bind")throw new Error("Function.prototype.bind is disabled");if(i===Function&&(r==="call"||r==="apply"))throw new Error("Function.prototype.call and Function.prototype.apply are disabled");return n===Function?n:n.bind(i)}return n},evalUnaryExpression(t,e){return{"-":i=>-k.evalAst(i,e),"!":i=>!k.evalAst(i,e),"~":i=>~k.evalAst(i,e),"+":i=>+k.evalAst(i,e),typeof:i=>typeof k.evalAst(i,e)}[t.operator](t.argument)},evalArrayExpression(t,e){return t.elements.map(r=>k.evalAst(r,e))},evalCallExpression(t,e){let r=t.arguments.map(n=>k.evalAst(n,e)),i=k.evalAst(t.callee,e);if(i===Function)throw new Error("Function constructor is disabled");return i(...r)},evalAssignmentExpression(t,e){if(t.left.type!=="Identifier")throw SyntaxError("Invalid left-hand side in assignment");let r=t.left.name;if(r==="__proto__")throw new Error("Assignment to __proto__ is disabled");let i=k.evalAst(t.right,e);return e[r]=i,e[r]}},qe=class{constructor(e){this.code=e,this.ast=ee(this.code)}runInNewContext(e){let r=Ze({},e);return k.evalAst(this.ast,r)}};Je=class extends Error{constructor(e){super('JSONPath should not be called with "new" (it prevents return of (unwrapped) scalar values)'),this.avoidNew=!0,this.value=e,this.name="NewError"}};P.prototype.evaluate=function(t,e,r,i){let n=this.parent,c=this.parentProperty,{flatten:f,wrap:w}=this;if(this.currResultType=this.resultType,this.currEval=this.eval,this.currSandbox=this.sandbox,r=r||this.callback,this.currOtherTypeCallback=i||this.otherTypeCallback,e=e||this.json,t=t||this.path,t&&typeof t=="object"&&!Array.isArray(t)){if(!t.path&&t.path!=="")throw new TypeError('You must supply a "path" property when providing an object argument to JSONPath.evaluate().');if(!Object.hasOwn(t,"json"))throw new TypeError('You must supply a "json" property when providing an object argument to JSONPath.evaluate().');({json:e}=t),f=Object.hasOwn(t,"flatten")?t.flatten:f,this.currResultType=Object.hasOwn(t,"resultType")?t.resultType:this.currResultType,this.currSandbox=Object.hasOwn(t,"sandbox")?t.sandbox:this.currSandbox,w=Object.hasOwn(t,"wrap")?t.wrap:w,this.currEval=Object.hasOwn(t,"eval")?t.eval:this.currEval,r=Object.hasOwn(t,"callback")?t.callback:r,this.currOtherTypeCallback=Object.hasOwn(t,"otherTypeCallback")?t.otherTypeCallback:this.currOtherTypeCallback,n=Object.hasOwn(t,"parent")?t.parent:n,c=Object.hasOwn(t,"parentProperty")?t.parentProperty:c,t=t.path}if(n=n||null,c=c||null,Array.isArray(t)&&(t=P.toPathString(t)),!t&&t!==""||!e)return;let _=P.toPathArray(t);_[0]==="$"&&_.length>1&&_.shift(),this._hasParentSelector=null;let E=this._trace(_,e,["$"],n,c,r).filter(function(v){return v&&!v.isParentSelector});return E.length?!w&&E.length===1&&!E[0].hasArrExpr?this._getPreferredOutput(E[0]):E.reduce((v,d)=>{let O=this._getPreferredOutput(d);return f&&Array.isArray(O)?v=v.concat(O):v.push(O),v},[]):w?[]:void 0};P.prototype._getPreferredOutput=function(t){let e=this.currResultType;switch(e){case"all":{let r=Array.isArray(t.path)?t.path:P.toPathArray(t.path);return t.pointer=P.toPointer(r),t.path=typeof t.path=="string"?t.path:P.toPathString(t.path),t}case"value":case"parent":case"parentProperty":return t[e];case"path":return P.toPathString(t[e]);case"pointer":return P.toPointer(t.path);default:throw new TypeError("Unknown result type")}};P.prototype._handleCallback=function(t,e,r){if(e){let i=this._getPreferredOutput(t);t.path=typeof t.path=="string"?t.path:P.toPathString(t.path),e(i,r,t)}};P.prototype._trace=function(t,e,r,i,n,c,f,w){let _;if(!t.length)return _={path:r,value:e,parent:i,parentProperty:n,hasArrExpr:f},this._handleCallback(_,c,"value"),_;let E=t[0],v=t.slice(1),d=[];function O(g){Array.isArray(g)?g.forEach(C=>{d.push(C)}):d.push(g)}if((typeof E!="string"||w)&&e&&Object.hasOwn(e,E))O(this._trace(v,e[E],ie(r,E),e,E,c,f));else if(E==="*")this._walk(e,g=>{O(this._trace(v,e[g],ie(r,g),e,g,c,!0,!0))});else if(E==="..")O(this._trace(v,e,r,i,n,c,f)),this._walk(e,g=>{typeof e[g]=="object"&&O(this._trace(t.slice(),e[g],ie(r,g),e,g,c,!0))});else{if(E==="^")return this._hasParentSelector=!0,{path:r.slice(0,-1),expr:v,isParentSelector:!0};if(E==="~")return _={path:ie(r,E),value:n,parent:i,parentProperty:null},this._handleCallback(_,c,"property"),_;if(E==="$")O(this._trace(v,e,r,null,null,c,f));else if(/^(-?\d*):(-?\d*):?(\d*)$/u.test(E))O(this._slice(E,v,e,r,i,n,c));else if(E.indexOf("?(")===0){if(this.currEval===!1)throw new Error("Eval [?(expr)] prevented in JSONPath expression.");let g=E.replace(/^\?\((.*?)\)$/u,"$1"),C=/@.?([^?]*)[['](\??\(.*?\))(?!.\)\])[\]']/gu.exec(g);C?this._walk(e,S=>{let K=[C[2]],J=C[1]?e[S][C[1]]:e[S];this._trace(K,J,r,i,n,c,!0).length>0&&O(this._trace(v,e[S],ie(r,S),e,S,c,!0))}):this._walk(e,S=>{this._eval(g,e[S],S,r,i,n)&&O(this._trace(v,e[S],ie(r,S),e,S,c,!0))})}else if(E[0]==="("){if(this.currEval===!1)throw new Error("Eval [(expr)] prevented in JSONPath expression.");O(this._trace(He(this._eval(E,e,r.at(-1),r.slice(0,-1),i,n),v),e,r,i,n,c,f))}else if(E[0]==="@"){let g=!1,C=E.slice(1,-2);switch(C){case"scalar":(!e||!["object","function"].includes(typeof e))&&(g=!0);break;case"boolean":case"string":case"undefined":case"function":typeof e===C&&(g=!0);break;case"integer":Number.isFinite(e)&&!(e%1)&&(g=!0);break;case"number":Number.isFinite(e)&&(g=!0);break;case"nonFinite":typeof e=="number"&&!Number.isFinite(e)&&(g=!0);break;case"object":e&&typeof e===C&&(g=!0);break;case"array":Array.isArray(e)&&(g=!0);break;case"other":g=this.currOtherTypeCallback(e,r,i,n);break;case"null":e===null&&(g=!0);break;default:throw new TypeError("Unknown value type "+C)}if(g)return _={path:r,value:e,parent:i,parentProperty:n},this._handleCallback(_,c,"value"),_}else if(E[0]==="`"&&e&&Object.hasOwn(e,E.slice(1))){let g=E.slice(1);O(this._trace(v,e[g],ie(r,g),e,g,c,f,!0))}else if(E.includes(",")){let g=E.split(",");for(let C of g)O(this._trace(He(C,v),e,r,i,n,c,!0))}else!w&&e&&Object.hasOwn(e,E)&&O(this._trace(v,e[E],ie(r,E),e,E,c,f,!0))}if(this._hasParentSelector)for(let g=0;g<d.length;g++){let C=d[g];if(C&&C.isParentSelector){let S=this._trace(C.expr,e,C.path,i,n,c,f);if(Array.isArray(S)){d[g]=S[0];let K=S.length;for(let J=1;J<K;J++)g++,d.splice(g,0,S[J])}else d[g]=S}}return d};P.prototype._walk=function(t,e){if(Array.isArray(t)){let r=t.length;for(let i=0;i<r;i++)e(i)}else t&&typeof t=="object"&&Object.keys(t).forEach(r=>{e(r)})};P.prototype._slice=function(t,e,r,i,n,c,f){if(!Array.isArray(r))return;let w=r.length,_=t.split(":"),E=_[2]&&Number.parseInt(_[2])||1,v=_[0]&&Number.parseInt(_[0])||0,d=_[1]&&Number.parseInt(_[1])||w;v=v<0?Math.max(0,v+w):Math.min(w,v),d=d<0?Math.max(0,d+w):Math.min(w,d);let O=[];for(let g=v;g<d;g+=E)this._trace(He(g,e),r,i,n,c,f,!0).forEach(S=>{O.push(S)});return O};P.prototype._eval=function(t,e,r,i,n,c){this.currSandbox._$_parentProperty=c,this.currSandbox._$_parent=n,this.currSandbox._$_property=r,this.currSandbox._$_root=this.json,this.currSandbox._$_v=e;let f=t.includes("@path");f&&(this.currSandbox._$_path=P.toPathString(i.concat([r])));let w=this.currEval+"Script:"+t;if(!P.cache[w]){let _=t.replaceAll("@parentProperty","_$_parentProperty").replaceAll("@parent","_$_parent").replaceAll("@property","_$_property").replaceAll("@root","_$_root").replaceAll(/@([.\s)[])/gu,"_$_v$1");if(f&&(_=_.replaceAll("@path","_$_path")),this.currEval==="safe"||this.currEval===!0||this.currEval===void 0)P.cache[w]=new this.safeVm.Script(_);else if(this.currEval==="native")P.cache[w]=new this.vm.Script(_);else if(typeof this.currEval=="function"&&this.currEval.prototype&&Object.hasOwn(this.currEval.prototype,"runInNewContext")){let E=this.currEval;P.cache[w]=new E(_)}else if(typeof this.currEval=="function")P.cache[w]={runInNewContext:E=>this.currEval(_,E)};else throw new TypeError(`Unknown "eval" property "${this.currEval}"`)}try{return P.cache[w].runInNewContext(this.currSandbox)}catch(_){if(this.ignoreEvalErrors)return!1;throw new Error("jsonPath: "+_.message+": "+t)}};P.cache={};P.toPathString=function(t){let e=t,r=e.length,i="$";for(let n=1;n<r;n++)/^(~|\^|@.*?\(\))$/u.test(e[n])||(i+=/^[0-9*]+$/u.test(e[n])?"["+e[n]+"]":"['"+e[n]+"']");return i};P.toPointer=function(t){let e=t,r=e.length,i="";for(let n=1;n<r;n++)/^(~|\^|@.*?\(\))$/u.test(e[n])||(i+="/"+e[n].toString().replaceAll("~","~0").replaceAll("/","~1"));return i};P.toPathArray=function(t){let{cache:e}=P;if(e[t])return e[t].concat();let r=[],n=t.replaceAll(/@(?:null|boolean|number|string|integer|undefined|nonFinite|scalar|array|object|function|other)\(\)/gu,";$&;").replaceAll(/[['](\??\(.*?\))[\]'](?!.\])/gu,function(c,f){return"[#"+(r.push(f)-1)+"]"}).replaceAll(/\[['"]([^'\]]*)['"]\]/gu,function(c,f){return"['"+f.replaceAll(".","%@%").replaceAll("~","%%@@%%")+"']"}).replaceAll("~",";~;").replaceAll(/['"]?\.['"]?(?![^[]*\])|\[['"]?/gu,";").replaceAll("%@%",".").replaceAll("%%@@%%","~").replaceAll(/(?:;)?(\^+)(?:;)?/gu,function(c,f){return";"+f.split("").join(";")+";"}).replaceAll(/;;;|;;/gu,";..;").replaceAll(/;$|'?\]|'$/gu,"").split(";").map(function(c){let f=c.match(/#(\d+)/u);return!f||!f[1]?c:r[f[1]]});return e[t]=n,e[t].concat()};P.prototype.safeVm={Script:qe};P.prototype.vm=mt.default});function ur(t,e){return P({path:e,json:t,wrap:!1})}var ae,Xe=B(()=>{"use strict";je();yt();pe();gt();ae=class{constructor(e={}){this.factMap=new Map,this.factResultsCache=new Map,this.allowUndefinedFacts=!!e.allowUndefinedFacts,this.pathResolver=e.pathResolver||ur,this.events={success:[],failure:[]},this.ruleResults=[]}addEvent(e,r){if(!r)throw new Error('outcome required: "success" | "failure"]');this.events[r].push(e)}getEvents(e=""){return e?this.events[e]:this.events.success.concat(this.events.failure)}addResult(e){this.ruleResults.push(e)}getResults(){return this.ruleResults}_getFact(e){return this.factMap.get(e)}_addConstantFact(e){this.factMap.set(e.id,e),this._setFactValue(e,{},e.value)}_setFactValue(e,r,i){let n=e.getCacheKey(r),c=Promise.resolve(i);return n&&this.factResultsCache.set(n,c),c}addFact(e,r,i){let n=e,c;return e instanceof z?(n=e.id,c=e):c=new z(e,r,i),I("almanac::addFact",{id:n}),this.factMap.set(n,c),c.isConstant()&&this._setFactValue(c,{},c.value),this}addRuntimeFact(e,r){I("almanac::addRuntimeFact",{id:e});let i=new z(e,r);return this._addConstantFact(i)}factValue(e,r={},i=""){let n,c=this._getFact(e);if(c===void 0)return this.allowUndefinedFacts?Promise.resolve(void 0):Promise.reject(new Pe(`Undefined fact: ${e}`));if(c.isConstant())n=Promise.resolve(c.calculate(r,this));else{let f=c.getCacheKey(r),w=f&&this.factResultsCache.get(f);w?(n=Promise.resolve(w),I("almanac::factValue cache hit for fact",{id:e})):(I("almanac::factValue cache miss, calculating",{id:e}),n=this._setFactValue(c,r,c.calculate(r,this)))}return i?(I("condition::evaluate extracting object",{property:i}),n.then(f=>{if(f!=null&&typeof f=="object"){let w=this.pathResolver(f,i);return I("condition::evaluate extracting object",{property:i,received:w}),w}else return I("condition::evaluate could not compute object path of non-object",{path:i,factValue:f,type:typeof f}),f})):n}getValue(e){return e!=null&&typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,"fact")?this.factValue(e.fact,e.params,e.path):Promise.resolve(e)}}});var T,Ae=B(()=>{"use strict";T=class{constructor(e,r,i){if(this.name=String(e),!e)throw new Error("Missing operator name");if(typeof r!="function")throw new Error("Missing operator callback");this.cb=r,this.factValueValidator=i,this.factValueValidator||(this.factValueValidator=()=>!0)}evaluate(e,r){return this.factValueValidator(e)&&this.cb(e,r)}}});function Se(t){return Number.parseFloat(t).toString()!=="NaN"}var W,vt,Et=B(()=>{"use strict";Ae();W=[];W.push(new T("equal",(t,e)=>t===e));W.push(new T("notEqual",(t,e)=>t!==e));W.push(new T("in",(t,e)=>e.indexOf(t)>-1));W.push(new T("notIn",(t,e)=>e.indexOf(t)===-1));W.push(new T("contains",(t,e)=>t.indexOf(e)>-1,Array.isArray));W.push(new T("doesNotContain",(t,e)=>t.indexOf(e)===-1,Array.isArray));W.push(new T("lessThan",(t,e)=>t<e,Se));W.push(new T("lessThanInclusive",(t,e)=>t<=e,Se));W.push(new T("greaterThan",(t,e)=>t>e,Se));W.push(new T("greaterThanInclusive",(t,e)=>t>=e,Se));vt=W});var $,Re=B(()=>{"use strict";Ae();$=class{constructor(e,r,i){if(this.name=String(e),!e)throw new Error("Missing decorator name");if(typeof r!="function")throw new Error("Missing decorator callback");this.cb=r,this.factValueValidator=i,this.factValueValidator||(this.factValueValidator=()=>!0)}decorate(e){let r=e.evaluate.bind(e);return new T(`${this.name}:${e.name}`,(i,n)=>this.cb(i,n,r),this.factValueValidator)}}});var le,wt,_t=B(()=>{"use strict";Re();le=[];le.push(new $("someFact",(t,e,r)=>t.some(i=>r(i,e)),Array.isArray));le.push(new $("someValue",(t,e,r)=>e.some(i=>r(t,i))));le.push(new $("everyFact",(t,e,r)=>t.every(i=>r(i,e)),Array.isArray));le.push(new $("everyValue",(t,e,r)=>e.every(i=>r(t,i))));le.push(new $("swap",(t,e,r)=>r(e,t)));le.push(new $("not",(t,e,r)=>!r(t,e)));wt=le});var xe,Ot=B(()=>{"use strict";Ae();Re();pe();xe=class{constructor(){this.operators=new Map,this.decorators=new Map}addOperator(e,r){let i;e instanceof T?i=e:i=new T(e,r),I("operatorMap::addOperator",{name:i.name}),this.operators.set(i.name,i)}removeOperator(e){let r;e instanceof T?r=e.name:r=e;let i=":"+r,n=Array.from(this.operators.keys());for(let c=0;c<n.length;c++)n[c].endsWith(i)&&this.operators.delete(n[c]);return this.operators.delete(r)}addOperatorDecorator(e,r){let i;e instanceof $?i=e:i=new $(e,r),I("operatorMap::addOperatorDecorator",{name:i.name}),this.decorators.set(i.name,i)}removeOperatorDecorator(e){let r;e instanceof $?r=e.name:r=e;let i=r+":",n=Array.from(this.operators.keys());for(let c=0;c<n.length;c++)n[c].includes(i)&&this.operators.delete(n[c]);return this.decorators.delete(r)}get(e){let r=[],i=e;for(;!this.operators.has(i);){let c=i.indexOf(":");if(c>0){let f=i.slice(0,c),w=this.decorators.get(f);if(!w)return I("operatorMap::get invalid decorator",{name:f}),null;r.unshift(w),i=i.slice(c+1)}else return I("operatorMap::get no operator",{name:i}),null}let n=this.operators.get(i);for(let c=0;c<r.length;c++)n=r[c].decorate(n),this.operators.set(n.name,n);return n}}});var jt,hr,At,xt,Ye,ze,Ct=B(()=>{"use strict";je();Be();Xe();jt=ge(Ue());Et();_t();pe();Me();Ot();hr="READY",At="RUNNING",xt="FINISHED",Ye=class extends jt.default{constructor(e=[],r={}){super(),this.rules=[],this.allowUndefinedFacts=r.allowUndefinedFacts||!1,this.allowUndefinedConditions=r.allowUndefinedConditions||!1,this.replaceFactsInEventParams=r.replaceFactsInEventParams||!1,this.pathResolver=r.pathResolver,this.operators=new xe,this.facts=new Map,this.conditions=new Map,this.status=hr,e.map(i=>this.addRule(i)),vt.map(i=>this.addOperator(i)),wt.map(i=>this.addOperatorDecorator(i))}addRule(e){if(!e)throw new Error("Engine: addRule() requires options");let r;if(e instanceof de)r=e;else{if(!Object.prototype.hasOwnProperty.call(e,"event"))throw new Error('Engine: addRule() argument requires "event" property');if(!Object.prototype.hasOwnProperty.call(e,"conditions"))throw new Error('Engine: addRule() argument requires "conditions" property');r=new de(e)}return r.setEngine(this),this.rules.push(r),this.prioritizedRules=null,this}updateRule(e){let r=this.rules.findIndex(i=>i.name===e.name);if(r>-1)this.rules.splice(r,1),this.addRule(e),this.prioritizedRules=null;else throw new Error("Engine: updateRule() rule not found")}removeRule(e){let r=!1;if(e instanceof de){let i=this.rules.indexOf(e);i>-1&&(r=!!this.rules.splice(i,1).length)}else{let i=this.rules.filter(n=>n.name!==e);r=i.length!==this.rules.length,this.rules=i}return r&&(this.prioritizedRules=null),r}setCondition(e,r){if(!e)throw new Error("Engine: setCondition() requires name");if(!r)throw new Error("Engine: setCondition() requires conditions");if(!Object.prototype.hasOwnProperty.call(r,"all")&&!Object.prototype.hasOwnProperty.call(r,"any")&&!Object.prototype.hasOwnProperty.call(r,"not")&&!Object.prototype.hasOwnProperty.call(r,"condition"))throw new Error('"conditions" root must contain a single instance of "all", "any", "not", or "condition"');return this.conditions.set(e,new oe(r)),this}removeCondition(e){return this.conditions.delete(e)}addOperator(e,r){this.operators.addOperator(e,r)}removeOperator(e){return this.operators.removeOperator(e)}addOperatorDecorator(e,r){this.operators.addOperatorDecorator(e,r)}removeOperatorDecorator(e){return this.operators.removeOperatorDecorator(e)}addFact(e,r,i){let n=e,c;return e instanceof z?(n=e.id,c=e):c=new z(e,r,i),I("engine::addFact",{id:n}),this.facts.set(n,c),this}removeFact(e){let r;return e instanceof z?r=e.id:r=e,this.facts.delete(r)}prioritizeRules(){if(!this.prioritizedRules){let e=this.rules.reduce((r,i)=>{let n=i.priority;return r[n]||(r[n]=[]),r[n].push(i),r},{});this.prioritizedRules=Object.keys(e).sort((r,i)=>Number(r)>Number(i)?-1:1).map(r=>e[r])}return this.prioritizedRules}stop(){return this.status=xt,this}getFact(e){return this.facts.get(e)}evaluateRules(e,r){return Promise.all(e.map(i=>this.status!==At?(I("engine::run, skipping remaining rules",{status:this.status}),Promise.resolve()):i.evaluate(r).then(n=>(I("engine::run",{ruleResult:n.result}),r.addResult(n),n.result?(r.addEvent(n.event,"success"),this.emitAsync("success",n.event,r,n).then(()=>this.emitAsync(n.event.type,n.event.params,r,n))):(r.addEvent(n.event,"failure"),this.emitAsync("failure",n.event,r,n))))))}run(e={},r={}){I("engine::run started"),this.status=At;let i=r.almanac||new ae({allowUndefinedFacts:this.allowUndefinedFacts,pathResolver:this.pathResolver});this.facts.forEach(f=>{i.addFact(f)});for(let f in e){let w;e[f]instanceof z?w=e[f]:w=new z(f,e[f]),i.addFact(w),I("engine::run initialized runtime fact",{id:w.id,value:w.value,type:typeof w.value})}let n=this.prioritizeRules(),c=Promise.resolve();return new Promise((f,w)=>{n.map(_=>(c=c.then(()=>this.evaluateRules(_,i)).catch(w),c)),c.then(()=>{this.status=xt,I("engine::run completed");let _=i.getResults(),{results:E,failureResults:v}=_.reduce((d,O)=>{let g=O.result?"results":"failureResults";return d[g].push(O),d},{results:[],failureResults:[]});f({almanac:i,results:E,failureResults:v,events:i.getEvents("success"),failureEvents:i.getEvents("failure")})}).catch(w)})}},ze=Ye});var Pt={};Nt(Pt,{Almanac:()=>ae,Engine:()=>ze,Fact:()=>z,Operator:()=>T,OperatorDecorator:()=>$,Rule:()=>de,default:()=>fr});function fr(t,e){return new ze(t,e)}var St=B(()=>{Ct();je();Be();Ae();Xe();Re()});module.exports=(St(),Mt(Pt));
/*! Bundled license information:

Belongs to Hitesh Chawla < www.hiteshlabs.com >

eventemitter2/lib/eventemitter2.js:
  (*!
   * EventEmitter2
   * https://github.com/hij1nx/EventEmitter2
   *
   * Copyright (c) 2013 hij1nx
   * Licensed under the MIT license.
   *)
*/
//# sourceMappingURL=index.js.map
